import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split, GridSearchCV
from sklearn.preprocessing import StandardScaler
from sklearn.pipeline import Pipeline
from sklearn.decomposition import PCA
from sklearn.tree import DecisionTreeRegressor
from sklearn.neighbors import KNeighborsRegressor
from sklearn.linear_model import LinearRegression, ElasticNet
from sklearn.svm import SVR, NuSVR
from sklearn.ensemble import GradientBoostingRegressor, RandomForestRegressor, AdaBoostRegressor
from xgboost import XGBRegressor
from sklearn.metrics import mean_squared_error, mean_absolute_error, r2_score

# Load dataset
dataset_path = 'Add.csv file path'
data = pd.read_csv(dataset_path)

# Split dataset into features and target variable
X = data.drop(columns=['Target title'])
y = data['Target title']

# === Three-way split ===
X_temp, X_unseen, y_temp, y_unseen = train_test_split(X, y, test_size=0.1, random_state=1)
X_train, X_test, y_train, y_test = train_test_split(X_temp, y_temp, test_size=0.2222, random_state=1)

# Define PCA component settings
pca_components_list = [10, 12, 15, 17, 19, 20]

# Initialize tracking variables
best_weight = 0
best_mean_test_score = float('-inf')

for pca_components in pca_components_list:
    print(f"\n===== PCA Components: {pca_components} =====")
    
    # Apply PCA
    pca = PCA(n_components=pca_components)
    X_train_pca = pca.fit_transform(X_train)
    X_test_pca = pca.transform(X_test)
    X_unseen_pca = pca.transform(X_unseen)

    for model_name, model_class, param_grid in [
        ('KNN', KNeighborsRegressor(), {'model__n_neighbors': [5, 10, 15, 20], 'model__weights': ['uniform', 'distance']}),
        ('Elastic Net', ElasticNet(), {'model__alpha': [0.0001, 0.001, 0.01, 0.1, 0.5, 1], 'model__l1_ratio': [0.1, 0.5, 0.9]}),
        ('Linear Regression', LinearRegression(), {}),
        ('SVR Linear', SVR(kernel='linear'), {'model__C': [0.1, 1, 10, 100]}),
        ('SVR RBF', SVR(kernel='rbf'), {'model__C': [0.1, 1, 10, 100], 'model__gamma': [0.1, 1, 10]}),
        ('Decision Tree', DecisionTreeRegressor(random_state=1), {'model__max_depth': [None, 10, 20, 30], 'model__min_samples_split': [2, 5, 10], 'model__min_samples_leaf': [1, 2, 4]}),
        ('Gradient Boosting', GradientBoostingRegressor(random_state=1), {'model__n_estimators': [50, 100, 200], 'model__learning_rate': [0.01, 0.05, 0.1], 'model__max_depth': [3, 5, 7]}),
        ('XGBoost', XGBRegressor(random_state=1), {'model__n_estimators': [50, 100, 200], 'model__learning_rate': [0.01, 0.05, 0.1], 'model__max_depth': [3, 5, 7]}),
        ('Random Forest', RandomForestRegressor(random_state=1), {'model__n_estimators': [100, 200], 'model__max_depth': [3, 5, 10], 'model__min_samples_split': [2, 5, 10], 'model__min_samples_leaf': [1, 2, 5]}),
        ('AdaBoost', AdaBoostRegressor(random_state=1), {'model__n_estimators': [100, 200, 300], 'model__learning_rate': [0.01, 0.05, 0.1]})
    ]:
        print(f"\nPCA Components: {pca_components} | Model: {model_name}")

        model_pipeline = Pipeline([
            ('scaler', StandardScaler()),
            ('model', model_class)
        ])

        model_grid_search = GridSearchCV(model_pipeline, param_grid, scoring='r2', cv=5)
        model_grid_search.fit(X_train_pca, y_train)

        best_model = model_grid_search.best_estimator_
        best_model_params = model_grid_search.best_params_
        
        r2_training = r2_score(y_train, best_model.predict(X_train_pca))
        r2_cv = model_grid_search.best_score_
        r2_testing = r2_score(y_test, best_model.predict(X_test_pca))
        r2_unseen = r2_score(y_unseen, best_model.predict(X_unseen_pca))
        
        mse = mean_squared_error(y_test, best_model.predict(X_test_pca))
        rmse = np.sqrt(mse)
        mae = mean_absolute_error(y_test, best_model.predict(X_test_pca))
        
        w_new = ((r2_training + r2_cv + r2_testing) / (mse + rmse + mae)) * (
            1 - abs(r2_training - r2_cv)) / (1 + abs(r2_training - r2_cv)) / (
            1 + ((r2_training + r2_cv + r2_testing) / (mse + rmse + mae)) * (
            1 - abs(r2_training - r2_cv)) / (1 + abs(r2_training - r2_cv)))

        if r2_training >= 0 and r2_cv >= 0 and model_grid_search.best_score_ > best_mean_test_score:
            best_mean_test_score = model_grid_search.best_score_
            best_weight = w_new

        print(f"🔹 Best Model: {best_model}")
        print(f"🔹 Best Model Parameters: {best_model_params}")
        print(f"🔹 R² Training Score: {r2_training:.4f}")
        print(f"🔹 R² Cross-Validation Score: {r2_cv:.4f}")
        print(f"🔹 R² Testing Score: {r2_testing:.4f}")
        print(f"🔹 R² Unseen Holdout Score: {r2_unseen:.4f}")
        print(f"🔹 MSE: {mse:.4f}, RMSE: {rmse:.4f}, MAE: {mae:.4f}")
        print(f"🔹 Weight (W_new): {w_new:.6f}")
        print("=" * 50)

print("\n===== Best Results Across PCA Configurations =====")
print(f"⭐ Best Weight: {best_weight:.6f}")
print(f"⭐ Best Mean Test Score: {best_mean_test_score:.4f}")
